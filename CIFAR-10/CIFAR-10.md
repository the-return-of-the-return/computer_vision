{"cells":[{"cell_type":"markdown","metadata":{"id":"yxStzukIQ2ff"},"source":["## pre"],"id":"yxStzukIQ2ff"},{"cell_type":"code","execution_count":2,"metadata":{"id":"w2lKGglDQfeM","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1640227898028,"user_tz":-480,"elapsed":31174,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}},"outputId":"693048c8-de0d-4dde-b470-1cd88de98d52"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["from google.colab import drive\n","drive.mount('/content/drive')"],"id":"w2lKGglDQfeM"},{"cell_type":"code","execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":1000},"executionInfo":{"elapsed":12203,"status":"ok","timestamp":1640227913317,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"},"user_tz":-480},"id":"7WG4ZFh1QrbZ","outputId":"1094932b-baf3-4e7b-de02-7318c3497265"},"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting matplotlib==3.4.3\n","  Downloading matplotlib-3.4.3-cp37-cp37m-manylinux1_x86_64.whl (10.3 MB)\n","\u001b[K     |████████████████████████████████| 10.3 MB 6.7 MB/s \n","\u001b[?25hCollecting d2l\n","  Downloading d2l-0.17.1-py3-none-any.whl (82 kB)\n","\u001b[K     |████████████████████████████████| 82 kB 772 kB/s \n","\u001b[?25hRequirement already satisfied: cycler>=0.10 in /usr/local/lib/python3.7/dist-packages (from matplotlib==3.4.3) (0.11.0)\n","Requirement already satisfied: python-dateutil>=2.7 in /usr/local/lib/python3.7/dist-packages (from matplotlib==3.4.3) (2.8.2)\n","Requirement already satisfied: pyparsing>=2.2.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib==3.4.3) (3.0.6)\n","Requirement already satisfied: numpy>=1.16 in /usr/local/lib/python3.7/dist-packages (from matplotlib==3.4.3) (1.19.5)\n","Requirement already satisfied: kiwisolver>=1.0.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib==3.4.3) (1.3.2)\n","Requirement already satisfied: pillow>=6.2.0 in /usr/local/lib/python3.7/dist-packages (from matplotlib==3.4.3) (7.1.2)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.7/dist-packages (from python-dateutil>=2.7->matplotlib==3.4.3) (1.15.0)\n","Requirement already satisfied: jupyter==1.0.0 in /usr/local/lib/python3.7/dist-packages (from d2l) (1.0.0)\n","Collecting pandas==1.2.2\n","  Downloading pandas-1.2.2-cp37-cp37m-manylinux1_x86_64.whl (9.9 MB)\n","\u001b[K     |████████████████████████████████| 9.9 MB 61.3 MB/s \n","\u001b[?25hCollecting numpy>=1.16\n","  Downloading numpy-1.18.5-cp37-cp37m-manylinux1_x86_64.whl (20.1 MB)\n","\u001b[K     |████████████████████████████████| 20.1 MB 63.6 MB/s \n","\u001b[?25hCollecting requests==2.25.1\n","  Downloading requests-2.25.1-py2.py3-none-any.whl (61 kB)\n","\u001b[K     |████████████████████████████████| 61 kB 9.4 MB/s \n","\u001b[?25hCollecting d2l\n","  Downloading d2l-0.17.0.post0-py3-none-any.whl (83 kB)\n","\u001b[K     |████████████████████████████████| 83 kB 2.4 MB/s \n","\u001b[?25h  Downloading d2l-0.17.0-py3-none-any.whl (83 kB)\n","\u001b[K     |████████████████████████████████| 83 kB 2.0 MB/s \n","\u001b[?25hRequirement already satisfied: pandas in /usr/local/lib/python3.7/dist-packages (from d2l) (1.1.5)\n","Requirement already satisfied: requests in /usr/local/lib/python3.7/dist-packages (from d2l) (2.23.0)\n","Requirement already satisfied: qtconsole in /usr/local/lib/python3.7/dist-packages (from jupyter==1.0.0->d2l) (5.2.1)\n","Requirement already satisfied: notebook in /usr/local/lib/python3.7/dist-packages (from jupyter==1.0.0->d2l) (5.3.1)\n","Requirement already satisfied: nbconvert in /usr/local/lib/python3.7/dist-packages (from jupyter==1.0.0->d2l) (5.6.1)\n","Requirement already satisfied: ipywidgets in /usr/local/lib/python3.7/dist-packages (from jupyter==1.0.0->d2l) (7.6.5)\n","Requirement already satisfied: ipykernel in /usr/local/lib/python3.7/dist-packages (from jupyter==1.0.0->d2l) (4.10.1)\n","Requirement already satisfied: jupyter-console in /usr/local/lib/python3.7/dist-packages (from jupyter==1.0.0->d2l) (5.2.0)\n","Requirement already satisfied: ipython>=4.0.0 in /usr/local/lib/python3.7/dist-packages (from ipykernel->jupyter==1.0.0->d2l) (5.5.0)\n","Requirement already satisfied: traitlets>=4.1.0 in /usr/local/lib/python3.7/dist-packages (from ipykernel->jupyter==1.0.0->d2l) (5.1.1)\n","Requirement already satisfied: tornado>=4.0 in /usr/local/lib/python3.7/dist-packages (from ipykernel->jupyter==1.0.0->d2l) (5.1.1)\n","Requirement already satisfied: jupyter-client in /usr/local/lib/python3.7/dist-packages (from ipykernel->jupyter==1.0.0->d2l) (5.3.5)\n","Requirement already satisfied: setuptools>=18.5 in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (57.4.0)\n","Requirement already satisfied: prompt-toolkit<2.0.0,>=1.0.4 in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (1.0.18)\n","Requirement already satisfied: decorator in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (4.4.2)\n","Requirement already satisfied: simplegeneric>0.8 in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (0.8.1)\n","Requirement already satisfied: pexpect in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (4.8.0)\n","Requirement already satisfied: pygments in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (2.6.1)\n","Requirement already satisfied: pickleshare in /usr/local/lib/python3.7/dist-packages (from ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (0.7.5)\n","Requirement already satisfied: wcwidth in /usr/local/lib/python3.7/dist-packages (from prompt-toolkit<2.0.0,>=1.0.4->ipython>=4.0.0->ipykernel->jupyter==1.0.0->d2l) (0.2.5)\n","Requirement already satisfied: jupyterlab-widgets>=1.0.0 in /usr/local/lib/python3.7/dist-packages (from ipywidgets->jupyter==1.0.0->d2l) (1.0.2)\n","Requirement already satisfied: widgetsnbextension~=3.5.0 in /usr/local/lib/python3.7/dist-packages (from ipywidgets->jupyter==1.0.0->d2l) (3.5.2)\n","Requirement already satisfied: nbformat>=4.2.0 in /usr/local/lib/python3.7/dist-packages (from ipywidgets->jupyter==1.0.0->d2l) (5.1.3)\n","Requirement already satisfied: ipython-genutils~=0.2.0 in /usr/local/lib/python3.7/dist-packages (from ipywidgets->jupyter==1.0.0->d2l) (0.2.0)\n","Requirement already satisfied: jsonschema!=2.5.0,>=2.4 in /usr/local/lib/python3.7/dist-packages (from nbformat>=4.2.0->ipywidgets->jupyter==1.0.0->d2l) (2.6.0)\n","Requirement already satisfied: jupyter-core in /usr/local/lib/python3.7/dist-packages (from nbformat>=4.2.0->ipywidgets->jupyter==1.0.0->d2l) (4.9.1)\n","Requirement already satisfied: terminado>=0.8.1 in /usr/local/lib/python3.7/dist-packages (from notebook->jupyter==1.0.0->d2l) (0.12.1)\n","Requirement already satisfied: Send2Trash in /usr/local/lib/python3.7/dist-packages (from notebook->jupyter==1.0.0->d2l) (1.8.0)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.7/dist-packages (from notebook->jupyter==1.0.0->d2l) (2.11.3)\n","Requirement already satisfied: pyzmq>=13 in /usr/local/lib/python3.7/dist-packages (from jupyter-client->ipykernel->jupyter==1.0.0->d2l) (22.3.0)\n","Requirement already satisfied: ptyprocess in /usr/local/lib/python3.7/dist-packages (from terminado>=0.8.1->notebook->jupyter==1.0.0->d2l) (0.7.0)\n","Requirement already satisfied: MarkupSafe>=0.23 in /usr/local/lib/python3.7/dist-packages (from jinja2->notebook->jupyter==1.0.0->d2l) (2.0.1)\n","Requirement already satisfied: mistune<2,>=0.8.1 in /usr/local/lib/python3.7/dist-packages (from nbconvert->jupyter==1.0.0->d2l) (0.8.4)\n","Requirement already satisfied: testpath in /usr/local/lib/python3.7/dist-packages (from nbconvert->jupyter==1.0.0->d2l) (0.5.0)\n","Requirement already satisfied: entrypoints>=0.2.2 in /usr/local/lib/python3.7/dist-packages (from nbconvert->jupyter==1.0.0->d2l) (0.3)\n","Requirement already satisfied: bleach in /usr/local/lib/python3.7/dist-packages (from nbconvert->jupyter==1.0.0->d2l) (4.1.0)\n","Requirement already satisfied: pandocfilters>=1.4.1 in /usr/local/lib/python3.7/dist-packages (from nbconvert->jupyter==1.0.0->d2l) (1.5.0)\n","Requirement already satisfied: defusedxml in /usr/local/lib/python3.7/dist-packages (from nbconvert->jupyter==1.0.0->d2l) (0.7.1)\n","Requirement already satisfied: webencodings in /usr/local/lib/python3.7/dist-packages (from bleach->nbconvert->jupyter==1.0.0->d2l) (0.5.1)\n","Requirement already satisfied: packaging in /usr/local/lib/python3.7/dist-packages (from bleach->nbconvert->jupyter==1.0.0->d2l) (21.3)\n","Requirement already satisfied: pytz>=2017.2 in /usr/local/lib/python3.7/dist-packages (from pandas->d2l) (2018.9)\n","Requirement already satisfied: qtpy in /usr/local/lib/python3.7/dist-packages (from qtconsole->jupyter==1.0.0->d2l) (1.11.2)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests->d2l) (1.24.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests->d2l) (2021.10.8)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests->d2l) (2.10)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests->d2l) (3.0.4)\n","Installing collected packages: matplotlib, d2l\n","  Attempting uninstall: matplotlib\n","    Found existing installation: matplotlib 3.2.2\n","    Uninstalling matplotlib-3.2.2:\n","      Successfully uninstalled matplotlib-3.2.2\n","\u001b[31mERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.\n","albumentations 0.1.12 requires imgaug<0.2.7,>=0.2.5, but you have imgaug 0.2.9 which is incompatible.\u001b[0m\n","Successfully installed d2l-0.17.0 matplotlib-3.4.3\n"]},{"output_type":"display_data","data":{"application/vnd.colab-display-data+json":{"pip_warning":{"packages":["matplotlib","mpl_toolkits"]}}},"metadata":{}}],"source":["pip install matplotlib==3.4.3 d2l"],"id":"7WG4ZFh1QrbZ"},{"cell_type":"code","execution_count":1,"metadata":{"id":"8a76e9c6","executionInfo":{"status":"ok","timestamp":1640227942686,"user_tz":-480,"elapsed":5968,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["import collections\n","import math\n","import os\n","import shutil\n","import pandas as pd\n","import torch\n","import torchvision\n","from torch import nn\n","from d2l import torch as d2l"],"id":"8a76e9c6"},{"cell_type":"markdown","metadata":{"id":"8256a17b"},"source":["## 获取并组织数据集"],"id":"8256a17b"},{"cell_type":"markdown","metadata":{"id":"58e57c29"},"source":["下载数据集"],"id":"58e57c29"},{"cell_type":"markdown","metadata":{"id":"77111fd5"},"source":["为了便于入门，我们提供包含前1000个训练图像和5个随机测试图像的数据集的小规模样本。 要使用Kaggle竞赛的完整数据集，你需要将以下demo变量设置为False"],"id":"77111fd5"},{"cell_type":"code","execution_count":2,"metadata":{"id":"6e488706","executionInfo":{"status":"ok","timestamp":1640227951329,"user_tz":-480,"elapsed":305,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["# d2l.DATA_HUB['cifar10_tiny'] = (d2l.DATA_URL + 'kaggle_cifar10_tiny.zip',\n","#                                 '2068874e4b9a9f0fb07ebe0ad2b29754449ccacd')\n","\n","# 如果你使用完整的Kaggle竞赛的数据集，设置demo为False\n","demo = False\n","\n","if demo:\n","    data_dir = d2l.download_extract('cifar10_tiny')\n","else:\n","    data_dir = '/content/drive/MyDrive/Colab Notebooks/data/cifar-10'"],"id":"6e488706"},{"cell_type":"markdown","metadata":{"id":"aed964f6"},"source":["整理数据集"],"id":"aed964f6"},{"cell_type":"code","execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":329,"status":"ok","timestamp":1640227966039,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"},"user_tz":-480},"id":"M9zcGocwQoNG","outputId":"ac0c9466-417f-40be-9c83-fd167420631b"},"outputs":[{"output_type":"stream","name":"stdout","text":["/content/drive/MyDrive/Colab Notebooks/computer_vision\n"]}],"source":["%cd /content/drive/MyDrive/'Colab Notebooks'/computer_vision"],"id":"M9zcGocwQoNG"},{"cell_type":"code","execution_count":4,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":811,"status":"ok","timestamp":1640227970946,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"},"user_tz":-480},"id":"2af2a68a","outputId":"4dee448e-2fc9-4e47-9fab-4f2744afdb39"},"outputs":[{"output_type":"stream","name":"stdout","text":["# 训练样本 : 50000\n","# 类别 : 10\n"]}],"source":["def read_csv_labels(fname):\n","    \"\"\"读取fname来给标签字典返回一个文件名\"\"\"\n","    with open(fname, 'r') as f:\n","        # 跳过文件头行(列名)\n","        lines = f.readlines()[1:]\n","    tokens = [l.rstrip().split(',') for l in lines]\n","    return dict(((name, label) for name, label in tokens))\n","\n","labels = read_csv_labels(os.path.join(data_dir, 'trainLabels.csv'))\n","print('# 训练样本 :', len(labels))\n","print('# 类别 :', len(set(labels.values())))"],"id":"2af2a68a"},{"cell_type":"markdown","metadata":{"id":"a9ea399f"},"source":["定义reorg_train_valid函数来将验证集从原始的训练集中拆分出来"],"id":"a9ea399f"},{"cell_type":"code","execution_count":5,"metadata":{"id":"60ef50cb","executionInfo":{"status":"ok","timestamp":1640227976882,"user_tz":-480,"elapsed":315,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["def copyfile(filename, target_dir):\n","    \"\"\"将文件复制到目标目录\"\"\"\n","    os.makedirs(target_dir, exist_ok=True)\n","    shutil.copy(filename, target_dir)\n","\n","def reorg_train_valid(data_dir, labels, valid_ratio):\n","    \"\"\"将验证集从原始的训练集中拆分出来\"\"\"\n","    # 训练数据集中样本最少的类别中的样本数\n","    n = collections.Counter(labels.values()).most_common()[-1][1]\n","    # 验证集中每个类别的样本数\n","    n_valid_per_label = max(1, math.floor(n * valid_ratio))\n","    label_count = {}\n","    for train_file in os.listdir(os.path.join(data_dir, 'train')):\n","        label = labels[train_file.split('.')[0]]\n","        fname = os.path.join(data_dir, 'train', train_file)\n","        copyfile(fname, os.path.join(data_dir, 'train_valid_test',\n","                                     'train_valid', label))\n","        if label not in label_count or label_count[label] < n_valid_per_label:\n","            copyfile(fname, os.path.join(data_dir, 'train_valid_test',\n","                                         'valid', label))\n","            label_count[label] = label_count.get(label, 0) + 1\n","        else:\n","            copyfile(fname, os.path.join(data_dir, 'train_valid_test',\n","                                         'train', label))\n","    return n_valid_per_label"],"id":"60ef50cb"},{"cell_type":"markdown","metadata":{"id":"5a6ab3d2"},"source":["下面的reorg_test函数用来在预测期间整理测试集，以方便读取"],"id":"5a6ab3d2"},{"cell_type":"code","execution_count":6,"metadata":{"id":"326cccf4","executionInfo":{"status":"ok","timestamp":1640227979524,"user_tz":-480,"elapsed":551,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["def reorg_test(data_dir):\n","    \"\"\"在预测期间整理测试集，以方便读取\"\"\"\n","    for test_file in os.listdir(os.path.join(data_dir, 'test')):\n","        copyfile(os.path.join(data_dir, 'test', test_file),\n","                 os.path.join(data_dir, 'train_valid_test', 'test',\n","                              'unknown'))"],"id":"326cccf4"},{"cell_type":"markdown","metadata":{"id":"be8068e3"},"source":["使用一个函数来调用前面定义的函数read_csv_labels、reorg_train_valid和reorg_test"],"id":"be8068e3"},{"cell_type":"code","execution_count":16,"metadata":{"id":"96802eb2","executionInfo":{"status":"ok","timestamp":1640229722190,"user_tz":-480,"elapsed":330,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["def reorg_cifar10_data(data_dir, valid_ratio):\n","    labels = read_csv_labels(os.path.join(data_dir, 'trainLabels.csv'))\n","    reorg_train_valid(data_dir, labels, valid_ratio)\n","    reorg_test(data_dir)"],"id":"96802eb2"},{"cell_type":"code","execution_count":17,"metadata":{"id":"62635aec","executionInfo":{"status":"ok","timestamp":1640229737812,"user_tz":-480,"elapsed":318,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["batch_size = 32 if demo else 128\n","valid_ratio = 0.1\n","reorg_cifar10_data(data_dir, valid_ratio)"],"id":"62635aec"},{"cell_type":"markdown","metadata":{"id":"590916c3"},"source":["## 图像增广"],"id":"590916c3"},{"cell_type":"code","execution_count":7,"metadata":{"id":"18ff3130","executionInfo":{"status":"ok","timestamp":1640228024215,"user_tz":-480,"elapsed":303,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["transform_train = torchvision.transforms.Compose([\n","    # 在高度和宽度上将图像放大到40像素的正方形\n","    torchvision.transforms.Resize(40),\n","    # 随机裁剪出一个高度和宽度均为40像素的正方形图像，\n","    # 生成一个面积为原始图像面积0.64到1倍的小正方形，\n","    # 然后将其缩放为高度和宽度均为32像素的正方形\n","    torchvision.transforms.RandomResizedCrop(32, scale=(0.64, 1.0),\n","                                                   ratio=(1.0, 1.0)),\n","    torchvision.transforms.RandomHorizontalFlip(),\n","    torchvision.transforms.ToTensor(),\n","    # 标准化图像的每个通道\n","    torchvision.transforms.Normalize([0.4914, 0.4822, 0.4465],\n","                                     [0.2023, 0.1994, 0.2010])])"],"id":"18ff3130"},{"cell_type":"code","execution_count":8,"metadata":{"id":"500481ff","executionInfo":{"status":"ok","timestamp":1640228025803,"user_tz":-480,"elapsed":339,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["transform_test = torchvision.transforms.Compose([\n","    torchvision.transforms.ToTensor(),\n","    torchvision.transforms.Normalize([0.4914, 0.4822, 0.4465],\n","                                     [0.2023, 0.1994, 0.2010])])"],"id":"500481ff"},{"cell_type":"markdown","metadata":{"id":"d7cb6932"},"source":["## 读取数据集"],"id":"d7cb6932"},{"cell_type":"code","source":["import py7zr\n","archive = py7zr.SevenZipFile(f'/content/drive/MyDrive/Colab Notebooks/data/cifar-10/test.7z', mode='r')\n","archive.extractall(path=f'/content/drive/MyDrive/Colab Notebooks/data/cifar-10/train_valid_test/test')\n","archive.close()"],"metadata":{"id":"1rXe64wCck6B","executionInfo":{"status":"ok","timestamp":1640235587258,"user_tz":-480,"elapsed":2552876,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"id":"1rXe64wCck6B","execution_count":52,"outputs":[]},{"cell_type":"code","execution_count":46,"metadata":{"id":"03132099","executionInfo":{"status":"ok","timestamp":1640231966213,"user_tz":-480,"elapsed":1985,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["train_ds, train_valid_ds = [torchvision.datasets.ImageFolder(\n","    os.path.join(data_dir, 'train_valid_test', folder),\n","    transform=transform_train) for folder in ['train', 'train_valid']]\n","\n","valid_ds = torchvision.datasets.ImageFolder(os.path.join(data_dir, 'train_valid_test', 'valid'),transform=transform_test)"],"id":"03132099"},{"cell_type":"code","source":["test_ds = torchvision.datasets.ImageFolder(os.path.join(data_dir, 'train_valid_test', 'test'),transform=transform_test)"],"metadata":{"id":"_tjrN6ryQG7I","executionInfo":{"status":"ok","timestamp":1640237993631,"user_tz":-480,"elapsed":5501,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"id":"_tjrN6ryQG7I","execution_count":53,"outputs":[]},{"cell_type":"code","execution_count":55,"metadata":{"id":"5cb5c51e","executionInfo":{"status":"ok","timestamp":1640238007477,"user_tz":-480,"elapsed":313,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["train_iter, train_valid_iter = [torch.utils.data.DataLoader(\n","    dataset, batch_size, shuffle=True, drop_last=True)\n","    for dataset in (train_ds, train_valid_ds)]\n","\n","valid_iter = torch.utils.data.DataLoader(valid_ds, batch_size, shuffle=False,\n","                                         drop_last=True)\n","\n","test_iter = torch.utils.data.DataLoader(test_ds, batch_size, shuffle=False,\n","                                        drop_last=False)"],"id":"5cb5c51e"},{"cell_type":"markdown","metadata":{"id":"62b58689"},"source":["## 定义模型"],"id":"62b58689"},{"cell_type":"code","execution_count":56,"metadata":{"id":"af0bfa63","executionInfo":{"status":"ok","timestamp":1640238010231,"user_tz":-480,"elapsed":310,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["def get_net():\n","    num_classes = 10\n","    net = d2l.resnet18(num_classes, 3)\n","    return net\n","loss = nn.CrossEntropyLoss(reduction=\"none\")"],"id":"af0bfa63"},{"cell_type":"markdown","metadata":{"id":"36b9ab48"},"source":["## 定义训练函数"],"id":"36b9ab48"},{"cell_type":"code","execution_count":57,"metadata":{"id":"c015d68a","executionInfo":{"status":"ok","timestamp":1640238011157,"user_tz":-480,"elapsed":2,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["def train(net, train_iter, valid_iter, num_epochs, lr, wd, devices, lr_period,\n","          lr_decay):\n","    trainer = torch.optim.SGD(net.parameters(), lr=lr, momentum=0.9,\n","                              weight_decay=wd)\n","    scheduler = torch.optim.lr_scheduler.StepLR(trainer, lr_period, lr_decay)\n","    num_batches, timer = len(train_iter), d2l.Timer()\n","    legend = ['train loss', 'train acc']\n","    if valid_iter is not None:\n","        legend.append('valid acc')\n","    animator = d2l.Animator(xlabel='epoch', xlim=[1, num_epochs],\n","                            legend=legend)\n","    net = nn.DataParallel(net, device_ids=devices).to(devices[0])\n","    for epoch in range(num_epochs):\n","        net.train()\n","        metric = d2l.Accumulator(3)\n","        for i, (features, labels) in enumerate(train_iter):\n","            timer.start()\n","            l, acc = d2l.train_batch_ch13(net, features, labels,\n","                                          loss, trainer, devices)\n","            metric.add(l, acc, labels.shape[0])\n","            timer.stop()\n","            if (i + 1) % (num_batches // 5) == 0 or i == num_batches - 1:\n","                animator.add(epoch + (i + 1) / num_batches,\n","                             (metric[0] / metric[2], metric[1] / metric[2],\n","                              None))\n","        if valid_iter is not None:\n","            valid_acc = d2l.evaluate_accuracy_gpu(net, valid_iter)\n","            animator.add(epoch + 1, (None, None, valid_acc))\n","        scheduler.step()\n","    measures = (f'train loss {metric[0] / metric[2]:.3f}, '\n","                f'train acc {metric[1] / metric[2]:.3f}')\n","    if valid_iter is not None:\n","        measures += f', valid acc {valid_acc:.3f}'\n","    print(measures + f'\\n{metric[2] * num_epochs / timer.sum():.1f}'\n","          f' examples/sec on {str(devices)}')"],"id":"c015d68a"},{"cell_type":"markdown","metadata":{"id":"54ba2d89"},"source":["## 训练和验证模型"],"id":"54ba2d89"},{"cell_type":"code","execution_count":58,"metadata":{"executionInfo":{"elapsed":2,"status":"ok","timestamp":1640238045399,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"},"user_tz":-480},"id":"2958e574"},"outputs":[],"source":["devices, num_epochs, lr, wd = d2l.try_all_gpus(), 20, 2e-4, 5e-4\n","lr_period, lr_decay= 4, 0.9\n","net = get_net()\n","train(net, train_iter, valid_iter, num_epochs, lr, wd, devices, lr_period, lr_decay)"],"id":"2958e574"},{"cell_type":"markdown","metadata":{"id":"f010e740"},"source":["## 在 Kaggle 上对测试集进行分类并提交结果"],"id":"f010e740"},{"cell_type":"code","source":["for i, (features, labels) in enumerate(train_valid_iter):\n","  print(labels)\n","  break"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"s3qaO3uiJ0lc","executionInfo":{"status":"ok","timestamp":1640238148465,"user_tz":-480,"elapsed":41175,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}},"outputId":"85b86e47-d834-473d-f30c-72ecd77e9640"},"id":"s3qaO3uiJ0lc","execution_count":59,"outputs":[{"output_type":"stream","name":"stdout","text":["tensor([7, 9, 9, 7, 9, 7, 1, 5, 0, 6, 4, 6, 2, 5, 5, 8, 0, 2, 8, 7, 9, 0, 4, 6,\n","        6, 7, 5, 2, 8, 8, 8, 0, 9, 4, 6, 9, 3, 9, 7, 6, 2, 5, 1, 2, 4, 3, 4, 2,\n","        3, 8, 6, 6, 2, 9, 1, 9, 6, 8, 1, 8, 6, 3, 8, 0, 7, 5, 9, 8, 6, 1, 6, 6,\n","        7, 4, 8, 9, 2, 2, 4, 8, 2, 3, 2, 8, 0, 2, 4, 7, 7, 4, 9, 6, 8, 1, 8, 3,\n","        2, 1, 6, 2, 5, 7, 6, 4, 3, 7, 0, 0, 3, 7, 5, 3, 0, 9, 1, 9, 1, 2, 0, 7,\n","        7, 8, 4, 8, 1, 5, 9, 5])\n"]}]},{"cell_type":"code","execution_count":60,"metadata":{"id":"VZjCJn31VO0U","executionInfo":{"status":"ok","timestamp":1640238157195,"user_tz":-480,"elapsed":337,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["net_1= get_net()\n","preds = []\n","train(net_1, train_valid_iter, None, num_epochs, lr, wd, devices, lr_period,\n","      lr_decay)"],"id":"VZjCJn31VO0U"},{"cell_type":"code","execution_count":66,"metadata":{"id":"R6pd4IhPV0_1","executionInfo":{"status":"ok","timestamp":1640238715737,"user_tz":-480,"elapsed":438377,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"outputs":[],"source":["for X, _ in test_iter:\n","    y_hat = net_1(X.to(devices[0]))\n","    preds.extend(y_hat.argmax(dim=1).type(torch.int32).cpu().numpy())\n","sorted_ids = list(range(1, len(test_ds) + 1))\n","sorted_ids.sort(key=lambda x: str(x))\n","df = pd.DataFrame({'id': sorted_ids, 'label': preds})\n","df['label'] = df['label'].apply(lambda x: train_valid_ds.classes[x])\n","df.to_csv('/content/drive/MyDrive/Colab Notebooks/data/cifar-10/result/submission.csv', index=False)"],"id":"R6pd4IhPV0_1"},{"cell_type":"code","source":["torch.save(net,'/content/drive/MyDrive/Colab Notebooks/data/cifar-10/model/net.pkl')"],"metadata":{"id":"BNfbHBmZGPMU"},"id":"BNfbHBmZGPMU","execution_count":null,"outputs":[]},{"cell_type":"code","source":["net = torch.load('/content/drive/MyDrive/Colab Notebooks/data/cifar-10/model/net.pkl')"],"metadata":{"id":"MqGOYlL3GrXh"},"id":"MqGOYlL3GrXh","execution_count":null,"outputs":[]},{"cell_type":"code","source":["torch.save(net_1,'/content/drive/MyDrive/Colab Notebooks/data/cifar-10/model/net_1.pkl')"],"metadata":{"id":"Ybn4OtJT0WwG"},"id":"Ybn4OtJT0WwG","execution_count":null,"outputs":[]},{"cell_type":"code","source":["net_1 = torch.load('/content/drive/MyDrive/Colab Notebooks/data/cifar-10/model/net_1.pkl')"],"metadata":{"id":"kMPz5mgkHAo-","executionInfo":{"status":"ok","timestamp":1640238252854,"user_tz":-480,"elapsed":404,"user":{"displayName":"Xun Xie","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"11401376503027420499"}}},"id":"kMPz5mgkHAo-","execution_count":65,"outputs":[]}],"metadata":{"accelerator":"GPU","colab":{"collapsed_sections":[],"name":"CIFAR-10.ipynb","provenance":[],"machine_shape":"hm"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":5}